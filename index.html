<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title></title>
    <link rel="stylesheet" href="styles.css?v=${new Date().getTime()}">
    <script src="https://cdn.jsdelivr.net/pyodide/v0.18.1/full/pyodide.js"></script>
    <style>
        /* 确保其他容器一开始是隐藏的 */
        #sections, #story, #settings {
            display: none;
        }
    </style>
    <script>
        async function loadPyodideAndPackages() {
            window.pyodide = await loadPyodide({
                indexURL: "https://cdn.jsdelivr.net/pyodide/v0.18.1/full/"
            });
            console.log('Pyodide loaded');
        }

        loadPyodideAndPackages().then(() => {
            console.log('Pyodide loaded and packages installed');
        });

        async function loadScript(url) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = `${url}?v=${new Date().getTime()}`;
                script.defer = true;
                script.onload = () => resolve(url);
                script.onerror = () => reject(url);
                document.body.appendChild(script);
            });
        }

        async function initializeApp() {
            // 加载 crypto 库
            await loadScript('https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js');
            // 加载语言文件
            await loadScript('scripts/loadLanguage.js');

            // 加载其余的脚本
            await loadScript('scripts/sections.js');
            await loadScript('scripts/saveLoad.js');
            await loadScript('scripts/interactionHandler.js');
            await loadScript('scripts/ui.js');
            await loadScript('scripts/settings.js');

            // 初始化UI和游戏设置
            initializeUI();
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeApp().catch(err => {
                console.error("Error loading scripts: ", err);
            });

            // 禁止默认的触摸滚动行为
            document.addEventListener('touchmove', function(event) {
                event.preventDefault();
            }, { passive: false });
        });
    </script>
</head>
<body>
    <div class="container" id="menu">
        <h1 id="mainTitle"></h1>
        <h2 id="subTitle"></h2>
        <button class="button" id="newGameButton" onclick="newGame()"></button>
        <button class="button" id="continueGameButton" onclick="continueGame()"></button>
        <button class="button" id="exportSaveButton" onclick="exportSave()"></button>
        <button class="button" id="importSaveButton" onclick="document.getElementById('fileInput').click()"></button>
        <button class="button" id="settingsButton" onclick="showSettings()"></button>
        <input id="fileInput" type="file" style="display: none;" onchange="importSave(event)">
    </div>
    
    <div class="container" id="sections"></div>

    <div class="container" id="story">
        <div class="image-container">
            <img id="sectionImage" src="" alt="章节图片">
        </div>
        <div class="text-container" id="storyContent"></div>
        <div class="controls">
            <input type="text" id="userInput" placeholder="在此输入你的选择..." />
            <button class="button" id="submitInputButton" onclick="submitUserInput()">提交</button>
        </div>
        <div id="loading" class="loading" style="display: none;">加载中...</div>
    </div>

    <div class="container" id="settings" style="display: none;">
        <h2>设置</h2>
        <label for="api-key">API Key</label>
        <input type="text" id="api-key" placeholder="输入你的API Key">
        <label for="api-url">API URL</label>
        <input type="text" id="api-url" placeholder="输入你的API URL" value="https://openkey.cloud/v1/">
        <button class="button" id="saveButton" onclick="saveSettings()">保存设置</button>
        <button class="button" id="freeTrialButton" onclick="getFreeTrialKey()">免费试玩key</button>
        <button class="button" id="exitButton" onclick="hideSettings()">退出</button>
        <p id="trialStatus"></p>
        <p id="downloadStatus"></p>
    </div>
</body>
</html>